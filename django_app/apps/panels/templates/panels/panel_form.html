{% extends "digital_clinic/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
    <div class="content-section">
        <form method="post">
            {% csrf_token %}

            <h1>Panel</h1>
            {{ form|crispy }}
            
            <h3>Tests</h3>
            <div class="row">
                <div class="col-md-6">
                    {{ formset.management_form }}
                    
                    <div hx-post="{% url 'panels:paneltest-sort' %}"
                        hx-target="closest div"
                        hx-trigger="load"
                        hx-swap="outerHTML">
                    </div>

                    <ul id="paneltest-del">
                        {% for f in formset %}
                            {% with i=f.instance %}
                                {% with t=i.test p=i.panel %}
                                    {% if f.DELETE.value %}
                                        {% include 'panels/partials/paneltest_form.html' with paneltest_pk=i.pk prefix=f.prefix test_name=t.name test_pk=t.pk del="on" %}
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </ul>

                    <ul id="paneltest-list"
                        class="sortable list-group"
                        hx-post="{% url 'panels:paneltest-sort' %}"
                        hx-trigger="end"
                        hx-swap="none">

                        {% for f in formset %}
                            {% with i=f.instance %}
                                {% with t=i.test %}
                                    {% if not f.DELETE.value %}
                                        {% include 'panels/partials/paneltest_form.html' with paneltest_pk=i.pk prefix=f.prefix test_name=t.name test_pk=t.pk order=i.order %}
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </ul>
                </div>

                <div class="col-md-6">
                    <div class="input-group mb-3">
                        <input class="form-control" type="search"
                            name="search" placeholder="Begin Typing To Search Tests..."
                            hx-post="{% url 'panels:test-search' %}"
                            hx-trigger="input changed delay:500ms, load"
                            hx-target="#search-results">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                    
                    <div id="search-results"></div>
                </div>

            </div>
            {% include 'digital_clinic/partials/form_actions.html' with pk=form.instance.pk url_list='panels:panel-list' url_detail='panels:panel-detail' %}
        </form>
    </div>

    <script>
        htmx.onLoad(function(content) {
            var sortables = content.querySelectorAll(".sortable");
            for (var i = 0; i < sortables.length; i++) {
                var sortable = sortables[i];
                new Sortable(sortable, {
                    animation: 150,
                    ghostClass: 'blue-background-class'
                });
            }
        })
    </script>
{% endblock %}